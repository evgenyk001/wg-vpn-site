<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Äî WG VPN</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">

    <!-- –õ–æ–≥–æ—Ç–∏–ø -->
    <div class="logo">
      <img src="logo-wg.png" alt="WG VPN Logo">
    </div>

    <!-- –ë–∞–ª–∞–Ω—Å -->
    <div class="section">
      <h2>–ë–∞–ª–∞–Ω—Å</h2>
      <div class="balance-box">
        <div class="balance" id="balance">...</div>
        <div class="status" id="days_left">...</div>
      </div>
      <div class="button-row">
        <a href="#" class="btn-red">–ü–æ–ø–æ–ª–Ω–∏—Ç—å</a>
        <a href="#" class="btn-red">–ò—Å—Ç–æ—Ä–∏—è</a>
      </div>
    </div>

    <!-- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ -->
    <div class="section">
      <h2>–ú–æ–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
      <div id="devices-container"></div>
      <div style="margin-top: 20px;">
        <a href="#" class="link">–î–æ–±–∞–≤–∏—Ç—å</a>
      </div>
    </div>

    <!-- –¢–∞—Ä–∏—Ñ -->
    <div class="section">
      <p class="tariff" id="tariff">...</p>
    </div>

    <!-- –†–µ—Ñ–µ—Ä–∞–ª–∫–∞ -->
    <div class="section">
      <h2>–ü—Ä–∏–≥–ª–∞—Å–∏ –¥—Ä—É–≥–∞ ‚Äî –ø–æ–ª—É—á–∏ 15‚ÇΩ</h2>
      <p style="color: #ccc; font-size: 15px;">
        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É –≤–∞—à—É —Å—Å—ã–ª–∫—É. –ö–æ–≥–¥–∞ –æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚Äî –≤—ã –ø–æ–ª—É—á–∏—Ç–µ <strong>15‚ÇΩ</strong> –Ω–∞ –±–∞–ª–∞–Ω—Å, –∞ –æ–Ω ‚Äî <strong>4 –¥–Ω—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ</strong>.
      </p>
      <div class="button-pair">
        <a href="#" onclick="copyLink()">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</a>
        <a href="https://t.me/WGVPN_official_bot" target="_blank">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</a>
      </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥ -->
<style>
  .back-button {
    display: inline-block;
    background-color: #222;
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    width: 100%;
    max-width: 400px;
    box-sizing: border-box;
    text-align: center;
    transition: transform 0.1s ease, background-color 0.2s ease;
  }

  .back-button:active {
    transform: scale(0.98);
    background-color: #333;
  }
</style>

<div style="text-align: center; margin: 20px 0;">
  <a href="index.html" class="back-button">–ù–∞–∑–∞–¥ –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
</div>
    
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="footer" style="text-align: center; font-size: 10px; color: #aaa; padding: 20px;">
  <p style="margin: 0;">
    <a href="privacy.html" style="color: #aaa; text-decoration: none;">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> |
    <a href="terms.html" style="color: #aaa; text-decoration: none;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ</a>
  </p>
  <p style="margin: 6px 0 0 0;">¬© WG VPN, 2025</p>
</div>

  </div>
<script>
window.onload = function () {
  const urlParams = new URLSearchParams(window.location.search);
  const urlId = urlParams.get('user_id');

  if (urlId) {
    localStorage.setItem('tg_id', urlId);
  }

  const tgId = localStorage.getItem('tg_id');

  if (!tgId) {
    document.getElementById('balance').textContent = '–û—à–∏–±–∫–∞: –Ω–µ—Ç user_id';
    document.getElementById('days_left').textContent = '-';
    document.getElementById('tariff').textContent = '-';
    document.getElementById('devices-container').textContent = '–û—à–∏–±–∫–∞: –Ω–µ—Ç user_id';
    return;
  }

  fetch(`https://api.wg-vpn.ru/api/user/${tgId}`)
    .then(response => response.json())
    .then(data => {
      if (!data || typeof data !== 'object') {
        document.getElementById('balance').textContent = '–û—à–∏–±–∫–∞: –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        document.getElementById('days_left').textContent = '-';
        document.getElementById('tariff').textContent = '-';
        document.getElementById('devices-container').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
        return;
      }

      // –ë–∞–ª–∞–Ω—Å
      const bonus = typeof data.bonus === 'number' ? data.bonus : 0;
      document.getElementById('balance').textContent = `${bonus} ‚ÇΩ`;

      // –î–Ω–∏ –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è
      const rawDate = (data.expires || '').split(' ')[0];
      const expires = new Date(rawDate + 'T00:00:00');
      const today = new Date();
      const diffDays = Math.max(0, Math.ceil((expires - today) / (1000 * 60 * 60 * 24)));
      document.getElementById('days_left').textContent = `–û—Å—Ç–∞–ª–æ—Å—å ${diffDays} –¥–Ω–µ–π`;

      // –¢–∞—Ä–∏—Ñ
      document.getElementById('tariff').textContent = decodeUTF8(data.tariff || '–ù–µ —É–∫–∞–∑–∞–Ω');

      // –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
      const container = document.getElementById('devices-container');
      container.innerHTML = '';

      if (Array.isArray(data.devices) && data.devices.length > 0) {
        data.devices.forEach(device => {
          const div = document.createElement('div');
          div.className = 'device-box';
          div.innerHTML = `
            <p>üì± ${device.type}</p>
            <p class="device-id">ID: dev-${tgId}</p>
          `;
          container.appendChild(div);
        });
      } else {
        const div = document.createElement('div');
        div.textContent = '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤';
        container.appendChild(div);
      }

      // === –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ ===
      const deviceType = detectDeviceType();
      const deviceId = generateDeviceId(tgId);

      const existingDevice = Array.isArray(data.devices)
        ? data.devices.find(d => d.id === deviceId)
        : null;

      if (!existingDevice) {
        fetch(`https://api.wg-vpn.ru/api/user/${tgId}/add-device`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: deviceId, type: deviceType })
        })
          .then(res => res.json())
          .then(res => {
            console.log("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ:", res);
            location.reload();
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:", err);
          });
      } else if (existingDevice.type !== deviceType) {
        fetch(`https://api.wg-vpn.ru/api/user/${tgId}/update-device`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: deviceId, type: deviceType })
        })
          .then(res => res.json())
          .then(res => {
            console.log("–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –æ–±–Ω–æ–≤–ª—ë–Ω:", res);
            location.reload();
          })
          .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:", err);
          });
      }
    })
    .catch(error => {
      document.getElementById('balance').textContent = '–û—à–∏–±–∫–∞';
      document.getElementById('days_left').textContent = '-';
      document.getElementById('tariff').textContent = '-';
      document.getElementById('devices-container').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
      console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
    });
};

// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function detectDeviceType() {
  const ua = navigator.userAgent;
  if (/android/i.test(ua)) return "Android";
  if (/iPad|iPhone|iPod/.test(ua)) return "iOS";
  if (/Windows/.test(ua)) return "Windows";
  if (/Macintosh/.test(ua)) return "macOS";
  if (/Linux/.test(ua)) return "Linux";
  return "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ";
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å —É—á—ë—Ç–æ–º Telegram ID –∏ —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
function generateDeviceId(tgId) {
  return 'dev-' + tgId;
}

// –î–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ UTF-8
function decodeUTF8(str) {
  try {
    return decodeURIComponent(escape(str));
  } catch {
    return str;
  }
}
</script>  
</body>
</html>
